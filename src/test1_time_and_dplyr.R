library(tidyverse)

# dataset1
d1 <- tibble(
  site = c("A", "A", "A", "A", "A",
           "B", "B", "B", "B", "B"),
  day = c("2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01"),
  val = c(100, 200, 300, 400, 500, 100, 200, 300, 400, 500)
)

d1

# siteごとのvalの合計を期間で集計する場合
d1 %>% 
  filter(day >= "2021-09-01", day < "2022-01-01") %>% 
  group_by(site) %>% 
  summarise(total_val = sum(val), .groups = "drop")

# dataset2
d2 <- tibble(
  site = c("A", "A", "A", "A", "A",
           "B", "B", "B", "B", "B",
           "C", "C", "C", "C", "C",
           "D", "D", "D", "D", "D"),
  day = c("2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01"),
  val = c(100, 200, 300, 400, 500, 
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500)
)

d2

# siteから"C"と"D"を除いたsiteごとのvalの合計を期間で集計する場合
d2 %>% 
  filter(site != "C" & site != "D") %>% 
  filter(day >= "2021-09-01", day < "2022-01-01") %>% 
  group_by(site) %>% 
  summarise(total_val = sum(val), .groups = "drop")

# dataset3
d3 <- tibble(
  site = c("A", "A", "A", "A", "A",
           "A", "A", "A", "A", "A",
           "A", "A", "A", "A", "A",
           "B", "B", "B", "B", "B",
           "B", "B", "B", "B", "B",
           "B", "B", "B", "B", "B",
           "C", "C", "C", "C", "C",
           "C", "C", "C", "C", "C",
           "C", "C", "C", "C", "C",
           "D", "D", "D", "D", "D",
           "D", "D", "D", "D", "D",
           "D", "D", "D", "D", "D"),
  day = c("2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01",
          "2021-09-01", "2021-10-01", "2021-11-01", "2021-12-01", "2022-01-01"),
  cat = c("cat_1", "cat_1", "cat_1", "cat_1", "cat_1",
          "cat_2", "cat_2", "cat_2", "cat_2", "cat_2",
          "cat_3", "cat_3", "cat_3", "cat_3", "cat_3",
          "cat_1", "cat_1", "cat_1", "cat_1", "cat_1",
          "cat_2", "cat_2", "cat_2", "cat_2", "cat_2",
          "cat_3", "cat_3", "cat_3", "cat_3", "cat_3",
          "cat_1", "cat_1", "cat_1", "cat_1", "cat_1",
          "cat_2", "cat_2", "cat_2", "cat_2", "cat_2",
          "cat_3", "cat_3", "cat_3", "cat_3", "cat_3",
          "cat_1", "cat_1", "cat_1", "cat_1", "cat_1",
          "cat_2", "cat_2", "cat_2", "cat_2", "cat_2",
          "cat_3", "cat_3", "cat_3", "cat_3", "cat_3"),
  val = c(100, 200, 300, 400, 500, 
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500,
          100, 200, 300, 400, 500)
)

d3

# siteから"C"と"D"、catから"cat_3"を除き、siteとcatごとのvalの合計を集計する場合
d3 %>% 
  filter(site != "C" & site != "D" & cat != "cat_3") %>% 
  filter(day >= "2021-09-01", day < "2022-01-01") %>% 
  group_by(site, cat) %>% 
  summarise(total_val = sum(val), .groups = "drop")

